import { ref, computed, watch } from 'vue'
import { defineStore } from 'pinia'
import type { CalendarDay } from '@/types/types.p'
import {getMouthEvents} from '@/api/calendar';

export const useCalendarStore = defineStore('calendar', () => {
  const days = ref<CalendarDay[]>([])
  const month = computed(() => date.value?.getMonth()); // 0-11
  const fetchingEvents = ref(false);
  const isLoading = computed(() => fetchingEvents.value);
  const date = ref<Date>(new Date());

  function goToday() {
    date.value = new Date();
  }

  function getMonth(){
    const mo = date.value?.getMonth() + 1;
    const string = mo.toString();
    if(string.length > 1) return string;

    return '0'+ string;
  }

  const yearMonth = computed(() => {
    return `${date.value.getFullYear()}-${getMonth()}`
  });

  async function getEventsFromMonth() {
    days.value = await getMouthEvents(yearMonth.value);
  }

  const expenses = computed(() => {
    return days.value.reduce((sum, event) => sum + event.expense, 0) ?? 0
  })

  const income = computed(() => {
    return days.value.reduce((sum, event) => sum + event.income, 0) ?? 0
  })

  watch(month, async () => {
    fetchingEvents.value = true;
    await getEventsFromMonth();
    fetchingEvents.value = false;
  })

  return { days, month, date, goToday, expenses, income, isLoading, getEventsFromMonth  }
})
